name: ðŸ“¦ NPM Version Bump
on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
        default: 'patch'

jobs:
  version-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      # Define packages to version (matches release-npm-packages.yaml)
      PACKAGES: bedrock-commands bedrock-diagnoser bedrock-project bedrock-types bedrock-vanilla-data molang project
      # Define IDE packages to version
      IDE_PACKAGES: base/client base/server shared vscode
    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ—ï¸ Setup Node.js Environment
        uses: actions/setup-node@v6
        with:
          cache: npm
          cache-dependency-path: package-lock.json
          node-version-file: .nvmrc

      - name: ðŸ—ï¸ Setup project
        run: npm ci

      - name: ðŸ“¦ Version NPM Packages
        run: |
          echo "## NPM Packages Versioning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for package in $PACKAGES; do
            echo "### Versioning package: $package" >> $GITHUB_STEP_SUMMARY
            cd "${{github.workspace}}/packages/$package"
            
            # Get current version
            current_version=$(node -p "require('./package.json').version")
            echo "Current version: $current_version" >> $GITHUB_STEP_SUMMARY
            
            # Run npm version
            npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
            
            # Get new version
            new_version=$(node -p "require('./package.json').version")
            echo "New version: $new_version" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            cd "${{github.workspace}}"
          done

      - name: ðŸ–¥ï¸ Version IDE Packages
        run: |
          echo "## IDE Packages Versioning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for ide_package in $IDE_PACKAGES; do
            echo "### Versioning IDE package: $ide_package" >> $GITHUB_STEP_SUMMARY
            cd "${{github.workspace}}/ide/$ide_package"
            
            # Get current version
            current_version=$(node -p "require('./package.json').version")
            echo "Current version: $current_version" >> $GITHUB_STEP_SUMMARY
            
            # Run npm version
            npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
            
            # Get new version
            new_version=$(node -p "require('./package.json').version")
            echo "New version: $new_version" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            cd "${{github.workspace}}"
          done

      - name: ðŸ·ï¸ Generate Tag List
        id: tags
        run: |
          echo "## Tags to be Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TAG_COMMANDS=""
          
          # Generate tags for each package
          for package in $PACKAGES; do
            version=$(node -p "require('./packages/$package/package.json').version")
            tag_name="$package-v$version"
            TAG_COMMANDS="$TAG_COMMANDS
            git tag -a \"$tag_name\" -m \"Release $package v$version\""
            echo "- \`$tag_name\`" >> $GITHUB_STEP_SUMMARY
          done
          
          # Generate tags for each IDE package
          for ide_package in $IDE_PACKAGES; do
            version=$(node -p "require('./ide/$ide_package/package.json').version")
            # Convert path to tag name (e.g., base/client -> base-client)
            tag_prefix=$(echo "$ide_package" | tr '/' '-')
            tag_name="ide-$tag_prefix-v$version"
            TAG_COMMANDS="$TAG_COMMANDS
            git tag -a \"$tag_name\" -m \"Release IDE $ide_package v$version\""
            echo "- \`$tag_name\`" >> $GITHUB_STEP_SUMMARY
          done
          
          # Save tag commands for PR body
          {
            echo 'tag_commands<<EOF'
            echo "$TAG_COMMANDS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: ðŸ—’ï¸ Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump version to ${{ github.event.inputs.version_type }}"
          branch: version-bump-${{ github.event.inputs.version_type }}-${{ github.run_number }}
          delete-branch: true
          title: "chore: bump version (${{ github.event.inputs.version_type }})"
          body: |
            ## ðŸ“¦ Version Bump: ${{ github.event.inputs.version_type }}
            
            This PR updates package versions across all npm packages and IDE components.
            
            ### Changes
            - âœ… Updated version in all npm packages
            - âœ… Updated version in all IDE packages (base/client, base/server, shared, vscode)
            
            ### Instructions
            
            After merging this PR, create and push tags using these commands:
            
            ```bash
            git checkout main
            git pull
            ${{ steps.tags.outputs.tag_commands }}
            git push --tags
            ```
          labels: |
            version-bump
            automated

      - name: ðŸ“ Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Version Bump Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version type: **${{ github.event.inputs.version_type }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created with the version updates." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "After merging, remember to create and push the git tags listed above." >> $GITHUB_STEP_SUMMARY
