name: ðŸ“¦ NPM Version Bump
on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prepatch
          - preminor
          - premajor
        default: 'patch'

jobs:
  version-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # Define packages to version (matches release-npm-packages.yaml)
      PACKAGES: bedrock-commands bedrock-diagnoser bedrock-project bedrock-types bedrock-vanilla-data molang project
    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ—ï¸ Setup Node.js Environment
        uses: actions/setup-node@v6
        with:
          cache: npm
          cache-dependency-path: package-lock.json
          node-version-file: .nvmrc

      - name: ðŸ”§ Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸ—ï¸ Setup project
        run: npm ci

      - name: ðŸ“¦ Version NPM Packages
        run: |
          echo "## NPM Packages Versioning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for package in $PACKAGES; do
            echo "### Versioning package: $package" >> $GITHUB_STEP_SUMMARY
            cd "${{github.workspace}}/packages/$package"
            
            # Get current version
            current_version=$(node -p "require('./package.json').version")
            echo "Current version: $current_version" >> $GITHUB_STEP_SUMMARY
            
            # Run npm version
            npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
            
            # Get new version
            new_version=$(node -p "require('./package.json').version")
            echo "New version: $new_version" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            cd "${{github.workspace}}"
          done

      - name: ðŸ–¥ï¸ Version VSCode IDE
        run: |
          echo "## VSCode IDE Versioning" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          cd "${{github.workspace}}/ide/vscode"
          
          # Get current version
          current_version=$(node -p "require('./package.json').version")
          echo "Current version: $current_version" >> $GITHUB_STEP_SUMMARY
          
          # Run npm version
          npm version ${{ github.event.inputs.version_type }} --no-git-tag-version
          
          # Get new version
          new_version=$(node -p "require('./package.json').version")
          echo "New version: $new_version" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ’¾ Commit Changes
        run: |
          git add -A
          git commit -m "chore: bump version to ${{ github.event.inputs.version_type }}"
          git push origin ${{ github.ref_name }}

      - name: ðŸ·ï¸ Create and Push Tags
        run: |
          echo "## Tags Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create tags for each package
          for package in $PACKAGES; do
            version=$(node -p "require('./packages/$package/package.json').version")
            tag_name="$package-v$version"
            git tag -a "$tag_name" -m "Release $package v$version"
            echo "- $tag_name" >> $GITHUB_STEP_SUMMARY
          done

          # Create tag for VSCode IDE
          vscode_version=$(node -p "require('./ide/vscode/package.json').version")
          vscode_tag="vscode-v$vscode_version"
          git tag -a "$vscode_tag" -m "Release VSCode IDE v$vscode_version"
          echo "- $vscode_tag" >> $GITHUB_STEP_SUMMARY

          # Push all tags
          git push --tags

      - name: ðŸ“ Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Version Bump Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version type: **${{ github.event.inputs.version_type }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All packages and IDE have been versioned and tagged successfully." >> $GITHUB_STEP_SUMMARY
